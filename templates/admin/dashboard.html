{% extends 'admin/base.html' %}

{% block content %}

<div class="main-header-line">
    <h1>Dashboard</h1>

    <div class="action-buttons">
        <!-- Botão pra abrir sidebar no mobile -->
        <button class="menu-button">
            <i class="bi bi-list"></i>
        </button>
    </div>
</div>

<!-- LINHA 1 – 3 cards de métricas (usa chart-row three do CodePen) -->
<div class="chart-row three">
    <div class="chart-container-wrapper">
        <div class="chart-container">
            <div class="chart-info-wrapper">
                <h2>Total de Conversas</h2>
                <span id="total-conv">--</span>
            </div>
        </div>
    </div>

    <div class="chart-container-wrapper">
        <div class="chart-container">
            <div class="chart-info-wrapper">
                <h2>Mensagens (Usuário)</h2>
                <span id="msg-user">--</span>
            </div>
        </div>
    </div>

    <div class="chart-container-wrapper">
        <div class="chart-container">
            <div class="chart-info-wrapper">
                <h2>Mensagens (Bot)</h2>
                <span id="msg-bot">--</span>
            </div>
        </div>
    </div>
</div>

<!-- LINHA 2 – gráfico grande + 2 gráficos menores (row two do CodePen) -->
<div class="chart-row two">
    <div class="chart-container-wrapper big">
        <div class="chart-container">
            <div class="chart-container-header">
                <h2>Conversas por dia</h2>
                <span>Últimos 30 dias</span>
            </div>
            <div class="line-chart">
                <canvas id="chart_daily" height="220"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-container-wrapper small">
        <div class="chart-container">
            <div class="chart-container-header">
                <h2>Mensagens por papel</h2>
            </div>
            <canvas id="chart_messages_bar" height="160"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-container-header">
                <h2>Distribuição de mensagens</h2>
            </div>
            <canvas id="chart_messages_donut" height="160"></canvas>
        </div>
    </div>
</div>

<!-- LINHA 3 – tabela de últimas conversas ocupando a largura toda -->
<div class="chart-row">
    <div class="chart-container-wrapper" style="width:100%;">
        <div class="chart-container">
            <div class="chart-container-header">
                <h2>Últimas Conversas</h2>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-striped table-sm mb-0">
                    <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Criado</th>
                        <th>Atualizado</th>
                        <th>User Msgs</th>
                        <th>Bot Msgs</th>
                    </tr>
                    </thead>
                    <tbody id="recent-table">
                    <!-- preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script>
fetch("/admin/api/reports")
    .then(r => r.json())
    .then(data => {
        document.getElementById("total-conv").innerText = data.conversation_counts.total_conversations;
        document.getElementById("msg-user").innerText = data.message_counts.user_messages;
        document.getElementById("msg-bot").innerText = data.message_counts.bot_messages;

        const tb = document.getElementById("recent-table");
        tb.innerHTML = "";
        data.recent_conversations.forEach(c => {
            tb.innerHTML += `
                <tr>
                    <td>${c.session_id}</td>
                    <td>${(c.created_at && c.created_at._seconds) ? new Date(c.created_at._seconds * 1000).toLocaleString("pt-BR") : ""}</td>
                    <td>${(c.updated_at && c.updated_at._seconds) ? new Date(c.updated_at._seconds * 1000).toLocaleString("pt-BR") : ""}</td>
                    <td>${c.total_user_messages}</td>
                    <td>${c.total_bot_messages}</td>
                </tr>
            `;
        });

        // ========================
        // GRÁFICO 1 - Conversas por dia (linha)
        // ========================
        const dates = Object.keys(data.daily_conversations);
        const values = Object.values(data.daily_conversations);

        new Chart(document.getElementById("chart_daily"), {
            type: "line",
            data: {
                labels: dates,
                datasets: [{
                    label: "Conversas por dia",
                    data: values,
                    borderColor: "rgba(0, 123, 255, 0.9)",
                    backgroundColor: "rgba(0, 123, 255, 0.3)",
                    tension: 0.3
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "white" } } },
                scales: {
                    x: { ticks: { color: "white" } },
                    y: { ticks: { color: "white" } }
                }
            }
        });

        // ========================
        // GRÁFICO 2 - User x Bot (BARRA)
        // ========================
        new Chart(document.getElementById("chart_messages_bar"), {
            type: "bar",
            data: {
                labels: ["Usuário", "Bot"],
                datasets: [{
                    label: "Mensagens",
                    data: [
                        data.message_counts.user_messages,
                        data.message_counts.bot_messages
                    ],
                    backgroundColor: [
                        "rgba(0, 200, 83, 0.8)",
                        "rgba(255, 193, 7, 0.8)"
                    ]
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "white" } } },
                scales: {
                    x: { ticks: { color: "white" } },
                    y: { ticks: { color: "white" } }
                }
            }
        });

        // ========================
        // GRÁFICO 3 - Donut (Proporção mensagens)
        // ========================
        new Chart(document.getElementById("chart_messages_donut"), {
            type: "doughnut",
            data: {
                labels: ["Usuário", "Bot"],
                datasets: [{
                    data: [
                        data.message_counts.user_messages,
                        data.message_counts.bot_messages
                    ],
                    backgroundColor: [
                        "rgba(0, 200, 83, 0.9)",
                        "rgba(255, 193, 7, 0.9)"
                    ]
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "white" } } }
            }
        });
    });
</script>

{% endblock %}
