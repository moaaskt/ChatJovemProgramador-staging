{% extends "admin/base.html" %}
{% block content %}

<div class="container-fluid conversations-page mt-3">
  <div class="main-header-line">
    <div class="d-flex align-items-center gap-2">
      <button id="sidebarToggle" class="sidebar-toggle-button">
        <svg class="btn-icon" viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <span class="rings"><span class="ring r1"></span><span class="ring r2"></span><span class="ring r3"></span></span>
      </button>
      <h1 class="page-title mb-0">Conversas</h1>
    </div>
    <div class="action-buttons">
      <button class="menu-button"><i class="bi bi-list"></i></button>
    </div>
  </div>
  <p class="conversations-subtitle">Histórico completo do ChatLeo</p>

  <div class="conversations-shell">
    <div class="row g-4">
      <div class="col-lg-4 col-12">
        <div class="sessions-panel card-section h-100 sessions-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="panel-title mb-0">Sessões recentes</h2>
            <span id="conv-total-badge" class="badge bg-secondary d-none"></span>
          </div>
          <p class="conversations-subtitle mb-2">
            Selecione uma sessão para ver o histórico à direita.
          </p>

          <div class="mb-2">
            <input type="text" id="conversation-search" class="form-control form-control-sm" placeholder="Buscar por ID">
          </div>

          <div class="sessions-list-wrapper">
            <div id="conv-list" class="list-group list-group-flush">
              <!-- itens via JS -->
              <div class="conversation-list-skeleton-item">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
              </div>
              <div class="conversation-list-skeleton-item">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
              </div>
              <div class="conversation-list-skeleton-item">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
              </div>
              <div class="conversation-list-skeleton-item">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8 col-12">
        <div class="chat-panel card-section h-100">
          <div class="chat-header d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center gap-2">
              <div class="chat-header-avatar d-flex align-items-center justify-content-center">
                <i class="bi bi-robot fs-4"></i>
              </div>
              <div class="chat-header-info">
                <span class="fw-semibold d-block">Histórico da conversa</span>
                <small id="conv-session-label" class="text-muted d-block"></small>
              </div>
            </div>
            <button type="button" id="download-conversation-btn" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1">
              <i class="bi bi-download"></i>
              <span>Baixar</span>
            </button>
          </div>

          <div id="chat-viewer" class="chat-panel-messages">
            <!-- conteúdo inicial/placeholder pode ser ajustado pelo JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
 // Variáveis globais para armazenar conversa atual
 let currentSessionId = null;
 let currentMessages = [];

function formatTimestamp(ts) {
   if (!ts || !ts._seconds) return "";
   return new Date(ts._seconds * 1000).toLocaleString("pt-BR");
 }

/**
 * Mostra o skeleton loading na lista de conversas
 */
function showConversationsSkeleton() {
    const listEl = document.getElementById("conv-list");
    if (!listEl) return;

    listEl.innerHTML = '';
    for (let i = 0; i < 4; i++) {
        const item = document.createElement("div");
        item.className = "conversation-list-skeleton-item";
        const line1 = document.createElement("div");
        line1.className = "skeleton-line";
        const line2 = document.createElement("div");
        line2.className = "skeleton-line";
        item.appendChild(line1);
        item.appendChild(line2);
        listEl.appendChild(item);
    }
}

/**
 * Esconde o skeleton loading na lista de conversas
 */
function hideConversationsSkeleton() {
    const listEl = document.getElementById("conv-list");
    if (!listEl) return;
    // Não faz nada aqui diretamente, pois loadConversations já vai substituir o innerHTML
    // A ideia é apenas que loadConversations sobrescreva o conteúdo do skeleton
}
 
 /**
  * Carrega a lista de conversas com filtros opcionais.
  * @param {Object} filters - Objeto com filtros (ex: { search: "texto" })
  */
 function loadConversations(filters = {}) {
    showConversationsSkeleton();

    // Construir query string a partir dos filtros
    const params = new URLSearchParams();
    
    if (filters.search && filters.search.trim() !== "") {
        params.append("search", filters.search.trim());
    }
    
    const queryString = params.toString();
    const url = queryString
        ? `/admin/api/conversations?${queryString}`
        : `/admin/api/conversations`;
    
    fetch(url)
      .then(r => r.json())
      .then(data => {
         const list = document.getElementById("conv-list");
         list.innerHTML = ""; // remove skeletons
         
         // Atualizar badge de total de conversas
         const badge = document.getElementById("conv-total-badge");
         if (badge && data.conversations.length > 0) {
           badge.classList.remove("d-none");
           const total = data.conversations.length;
           const label = total === 1 ? "sessão" : "sessões";
           badge.textContent = `${total} ${label}`;
         } else if (badge) {
           badge.classList.add("d-none");
         }
         
         data.conversations.forEach(c => {
             const totalUser = c.total_user_messages || 0;
             const totalBot = c.total_bot_messages || 0;
             const total = totalUser + totalBot;

             const item = document.createElement("button");
             item.type = "button";
             item.className = "list-group-item list-group-item-action session-item";
             item.dataset.sessionId = c.session_id;
             item.onclick = () => loadConversation(c.session_id);

             item.innerHTML = `
               <div class="d-flex w-100 justify-content-between align-items-start">
                 <div class="flex-grow-1 me-2">
                   <div class="fw-semibold small text-truncate">${c.session_id}</div>
                   <div class="text-muted sessions-meta small mt-1">
                     Criada: ${formatTimestamp(c.created_at)}<br>
                     Mensagens: ${total} (${totalUser} usuário / ${totalBot} bot)
                   </div>
                 </div>
                 <div class="text-end">
                   <span class="badge bg-primary-subtle text-primary-emphasis small d-block mb-1">
                     ${c.channel || "web"}
                   </span>
                 </div>
               </div>
             `;
             list.appendChild(item);
         });
      })
      .catch(error => {
          console.error("Erro ao carregar conversas:", error);
          const listEl = document.getElementById("conv-list");
          if (listEl) {
              listEl.innerHTML = '<p class="text-muted small px-3">Erro ao carregar conversas.</p>';
          }
      });
 }
 
function loadConversation(sessionId) {
    document.getElementById("conv-session-label").innerText = sessionId;
    const viewer = document.getElementById("chat-viewer");
    viewer.innerHTML = `
      <div class="d-flex justify-content-center align-items-center py-4">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <span class="text-muted small">Carregando mensagens...</span>
      </div>
    `;

    const items = document.querySelectorAll('#conv-list .list-group-item');
    items.forEach(el => {
      if (el.dataset.sessionId === sessionId) {
        el.classList.add('session-active');
      } else {
        el.classList.remove('session-active');
      }
    });

    fetch(`/admin/api/conversations/${sessionId}/messages`)
      .then(r => r.json())
      .then(data => {
         // Atualizar variáveis globais
         currentSessionId = sessionId;
         currentMessages = Array.isArray(data.messages) ? data.messages : [];
         
         viewer.innerHTML = "";
         if (!data.messages.length) {
             viewer.innerHTML = `
               <div class="text-center py-5 text-muted">
                 <i class="bi bi-chat-dots fs-1 d-block mb-2"></i>
                 <p class="mb-0">Nenhuma mensagem nesta conversa.</p>
               </div>
             `;
             return;
         }

         data.messages.forEach(msg => {
             const role = msg.role === "user" ? "user" : "bot";
             const row = document.createElement("div");
             row.className = "bubble-row";
             row.dataset.role = role;

             const bubble = document.createElement("div");
             bubble.className = role === "user" ? "bubble-user" : "bubble-bot";

             const contentEl = document.createElement("div");
             contentEl.className = "bubble-content";
             contentEl.textContent = msg.content || "";
             bubble.appendChild(contentEl);

             const meta = document.createElement("div");
             meta.className = "bubble-meta";
             meta.textContent = formatTimestamp(msg.created_at);

             if (role === "user") {
               const wrapper = document.createElement("div");
               wrapper.className = "ms-auto bubble-wrapper-user";
               wrapper.appendChild(bubble);
               wrapper.appendChild(meta);
               row.appendChild(wrapper);
             } else {
               const wrapper = document.createElement("div");
               wrapper.className = "me-auto bubble-wrapper-bot";
               wrapper.appendChild(bubble);
               wrapper.appendChild(meta);
               row.appendChild(wrapper);
             }

             viewer.appendChild(row);
         });

         viewer.scrollTop = viewer.scrollHeight;
      });
 }

 function downloadCurrentConversation() {
   if (!currentSessionId || !currentMessages || currentMessages.length === 0) {
     alert("Selecione uma sessão com mensagens antes de baixar a conversa.");
     return;
   }

   // Montar o conteúdo em texto simples
   let lines = [];
   lines.push(`ChatLeo - Histórico da conversa`);
   lines.push(`Sessão: ${currentSessionId}`);
   lines.push("");

   currentMessages.forEach(msg => {
     const roleRaw = msg.role || msg.papel || "bot";
     const role = roleRaw === "user" ? "usuário" : "bot";
     const content = msg.content || msg.texto || "";
     const ts = formatTimestamp(msg.created_at);
     lines.push(`[${ts}] (${role}) ${content}`);
   });

   const text = lines.join("\n");

   // Criar o arquivo .txt via Blob
   const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
   const url = URL.createObjectURL(blob);

   const a = document.createElement("a");
   a.href = url;
   a.download = `conversa_${currentSessionId}.txt`;
   document.body.appendChild(a);
   a.click();
   a.remove();
   URL.revokeObjectURL(url);
 }
 
/**
 * Função de debounce para evitar requisições excessivas durante a digitação.
 * @param {Function} fn - Função a ser executada
 * @param {number} delay - Tempo de espera em milissegundos
 * @returns {Function} Função com debounce aplicado
 */
function debounce(fn, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
    };
}

document.addEventListener("DOMContentLoaded", () => {
   // Configurar campo de busca com debounce
   const searchInput = document.getElementById("conversation-search");
   
   if (searchInput) {
       const debouncedSearch = debounce(() => {
           const value = searchInput.value || "";
           loadConversations({ search: value });
       }, 400); // 400ms de delay para evitar requisições em excesso
       
       searchInput.addEventListener("input", debouncedSearch);
   }
   
   // Carregar conversas inicialmente (sem filtros)
   loadConversations();
   
   const downloadBtn = document.getElementById("download-conversation-btn");
   if (downloadBtn) {
     downloadBtn.addEventListener("click", downloadCurrentConversation);
   }
});
</script>

{% endblock %}
