{% extends 'admin/base.html' %}

{% block content %}

<div class="main-header-line">
    <h1>Configura√ß√µes</h1>
    <div class="action-buttons">
        <button class="menu-button">
            <i class="bi bi-list"></i>
        </button>
    </div>
</div>

<!-- Se√ß√£o 1: Tema do Painel e Seguran√ßa lado a lado -->
<div class="row mt-4">

    <div class="col-md-6">
        <div class="card-section">
            <div class="section-title-wrapper">
                <h5 class="section-title">
                    <i class="bi bi-shield-lock"></i>
                    Seguran√ßa
                </h5>
            </div>
            
            <div class="card p-4">
                <div class="mb-3">
                    <label for="current-password" class="form-label">Senha Atual</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Digite sua senha atual">
                </div>
                
                <div class="mb-3">
                    <label for="new-password" class="form-label">Nova Senha</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Digite a nova senha">
                </div>
                
                <div class="mb-3">
                    <label for="confirm-password" class="form-label">Confirmar Nova Senha</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="Confirme a nova senha">
                </div>
                
                <button id="change-password" class="btn btn-primary">Alterar Senha</button>
            </div>
        </div>
    </div>


    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card-section">
            <div class="section-title-wrapper">
                <h5 class="section-title">
                    <i class="bi bi-palette"></i>
                    Tema do Painel
                </h5>
            </div>
            
            <div class="card p-4">
                <div class="mb-3">
                    <label class="form-label d-block mb-2">Tema</label>
                    
                    <!-- valor real que ser√° salvo -->
                    <input type="hidden"
                           id="admin-theme-value"
                           value="{{ admin_theme or 'dark' }}">
                    
                    <div class="theme-toggle-wrapper">
                        <span class="theme-toggle-label">Claro</span>
                        
                        <button type="button"
                                id="admin-theme-toggle"
                                class="theme-toggle"
                                data-theme="{{ admin_theme or 'dark' }}"
                                aria-label="Alternar tema do painel">
                            <span class="theme-toggle-icon">üåû</span>
                            <span class="theme-toggle-thumb"></span>
                            <span class="theme-toggle-icon">üåô</span>
                        </button>
                        
                        <span class="theme-toggle-label">Escuro</span>
                    </div>
                </div>
                
                <small class="text-muted">
                    O tema √© aplicado ao painel administrativo como modo claro ou escuro.
                </small>
            </div>
        </div>
    </div>
    
    
</div>

<!-- Se√ß√£o 2: Personaliza√ß√£o do Chat -->
<div class="card-section mt-4">
    <div class="section-title-wrapper">
        <h5 class="section-title">
            <i class="bi bi-chat-dots"></i>
            Personaliza√ß√£o do Chat
        </h5>
    </div>
    
    <div class="card p-4">
        <div class="mb-3">
            <label for="chat-title" class="form-label">T√≠tulo do Chat</label>
            <input type="text" id="chat-title" class="form-control" placeholder="ChatLeo">
        </div>
        
        <div class="mb-3">
            <label for="welcome-message" class="form-label">Mensagem de Boas-vindas</label>
            <textarea id="welcome-message" class="form-control" rows="3" placeholder="Ol√°! üëã Sou o assistente..."></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="bot-avatar" class="form-label">URL Avatar do Bot</label>
                <input type="text" id="bot-avatar" class="form-control" placeholder="/static/assets/logo.png">
            </div>
            <div class="col-md-6 mb-3">
                <label for="user-avatar" class="form-label">URL Avatar do Usu√°rio</label>
                <input type="text" id="user-avatar" class="form-control" placeholder="/static/assets/logo-user.png">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="primary-color" class="form-label">Cor Prim√°ria</label>
                <input type="color" id="primary-color" class="form-control form-control-color" value="#3D7EFF">
            </div>
            <div class="col-md-6 mb-3">
                <label for="secondary-color" class="form-label">Cor Secund√°ria</label>
                <input type="color" id="secondary-color" class="form-control form-control-color" value="#8B5CF6">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="bot-bubble-color" class="form-label">Cor do Bal√£o do Bot</label>
                <input
                    type="color"
                    id="bot-bubble-color"
                    class="form-control form-control-color"
                    value="#3D7EFF"
                >
                <small class="text-muted d-block mt-1">
                    Cor das mensagens enviadas pelo assistente (bot).
                </small>
            </div>
        </div>
        
        <!-- Papel de Parede do Chat -->
        <div class="mb-3 mt-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <label class="form-label mb-0">Papel de Parede do Chat</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="chat-background-enabled" role="switch" checked>
                    <label class="form-check-label" for="chat-background-enabled">Ativar papel de parede</label>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="chat-background-type" class="form-label">Tipo de Fundo</label>
                <select id="chat-background-type" class="form-select">
                    <option value="default">Usar padr√£o do sistema</option>
                    <option value="color">Cor s√≥lida</option>
                    <option value="image">Imagem</option>
                </select>
            </div>
            
            <div class="mb-3" id="chat-background-color-wrapper" style="display: none;">
                <label for="chat-background-color" class="form-label">Cor de Fundo</label>
                <input type="color" id="chat-background-color" class="form-control form-control-color" value="#1b2936">
            </div>
            
            <div class="mb-3" id="chat-background-image-wrapper" style="display: none;">
                <label for="chat-background-image-url" class="form-label">URL da Imagem de Fundo</label>
                <input type="text" id="chat-background-image-url" class="form-control" placeholder="https://exemplo.com/imagem.jpg">
                <small class="text-muted d-block mt-2">
                    Informe uma URL v√°lida de uma imagem. A imagem ser√° redimensionada para cobrir todo o fundo do chat.
                </small>
            </div>
        </div>
        
    </div>
    
    <!-- Previews lado a lado -->
    <div class="row mt-4">
        <div class="col-md-6 mb-3 mb-md-0">
            <div class="card-section">
                <div class="section-title-wrapper">
                    <h5 class="section-title">
                        <i class="bi bi-circle"></i>
                        Preview do Launcher
                    </h5>
                </div>
                <div class="launcher-preview-wrapper">
                    <div class="launcher-preview-surface">
                        <!-- canto inferior direito simulando a p√°gina -->
                        <div class="launcher-preview-bubble" id="launcher-preview-bubble">
                            <div class="launcher-preview-avatar">
                                <img id="launcher-preview-avatar" src="/static/assets/logo.png" alt="Avatar do bot">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card-section">
                <div class="section-title-wrapper">
                    <h5 class="section-title">
                       <i class="bi bi-eye" ></i>
                        Pr√©-visualiza√ß√£o do Chat
                    </h5>
                </div>

                <div id="chat-preview" class="chat-preview">
                    <div class="chat-preview-header">
                        <div class="chat-preview-avatar">
                            <img id="chat-preview-bot-avatar" src="/static/assets/logo.png" alt="Avatar do bot">
                        </div>
                        <div class="chat-preview-title-group">
                            <div id="chat-preview-title" class="chat-preview-title">ChatLeo</div>
                            <small class="chat-preview-subtitle">Janela de exemplo do usu√°rio</small>
                        </div>
                    </div>

                    <div class="chat-preview-body">
                        <!-- Mensagem do BOT (esquerda) -->
                        <div class="chat-preview-bot-message">
                            <div class="chat-preview-bot-bubble">
                                <span id="chat-preview-bot-message">
                                    Ol√°! üëã Sou o assistente...
                                </span>
                            </div>
                        </div>
                        
                        <!-- Mensagem do USU√ÅRIO (direita) -->
                        <div class="chat-preview-user-message">
                            <div class="chat-preview-user-bubble">
                                <span id="chat-preview-user-message">
                                    Ol√°! Como voc√™ pode me ajudar?
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-preview-quick-actions" id="chat-preview-quick-actions" style="padding: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <!-- Bot√µes de preview ser√£o injetados via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>


      <!-- Bot√µes r√°pidos -->
    <div class="mb-3 mt-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <label class="form-label mb-0">Bot√µes r√°pidos</label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="quick-actions-enabled" role="switch">
                <label class="form-check-label" for="quick-actions-enabled">Ativar bot√µes r√°pidos no chat</label>
            </div>
        </div>
        
        <div id="quick-actions-list" class="mb-3">
            <!-- Linhas de bot√µes ser√£o injetadas via JS -->
        </div>
        
        <button type="button" id="add-quick-action-btn" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-plus"></i> Adicionar bot√£o r√°pido
        </button>
        
        <small class="text-muted d-block mt-2">
            Configure os bot√µes r√°pidos que aparecer√£o no chat. M√°ximo de 4 bot√µes recomendado.
        </small>
    </div>
    <button id="save-chat-config" class="btn btn-primary mt-4">Salvar Configura√ß√µes do Chat</button>
</div>

<!-- Mensagens de feedback -->
<div id="settings-feedback" class="mt-3" style="display: none;"></div>

<script>
// Fun√ß√£o para mostrar/esconder campos de papel de parede baseado no tipo
function toggleBackgroundFields(type) {
    const colorWrapper = document.getElementById("chat-background-color-wrapper");
    const imageWrapper = document.getElementById("chat-background-image-wrapper");
    
    if (type === "color") {
        if (colorWrapper) colorWrapper.style.display = "block";
        if (imageWrapper) imageWrapper.style.display = "none";
    } else if (type === "image") {
        if (colorWrapper) colorWrapper.style.display = "none";
        if (imageWrapper) imageWrapper.style.display = "block";
    } else {
        // default
        if (colorWrapper) colorWrapper.style.display = "none";
        if (imageWrapper) imageWrapper.style.display = "none";
    }
}

// Fun√ß√£o para atualizar a pr√©-visualiza√ß√£o do chat
function updateChatPreview() {
    const titleInput = document.getElementById("chat-title");
    const messageInput = document.getElementById("welcome-message");
    const botAvatarInput = document.getElementById("bot-avatar");
    const primaryColorInput = document.getElementById("primary-color");
    const secondaryColorInput = document.getElementById("secondary-color");

    const previewRoot = document.getElementById("chat-preview");
    const previewTitle = document.getElementById("chat-preview-title");
    const previewBotMessage = document.getElementById("chat-preview-bot-message");
    const previewUserMessage = document.getElementById("chat-preview-user-message");
    const previewAvatar = document.getElementById("chat-preview-bot-avatar");

    if (!previewRoot) return;

    const title = (titleInput && titleInput.value) || "ChatLeo";
    const message = (messageInput && messageInput.value) || "Ol√°! üëã Sou o assistente...";
    const botAvatar = (botAvatarInput && botAvatarInput.value) || "/static/assets/logo.png";
    const primary = (primaryColorInput && primaryColorInput.value) || "#3D7EFF";
    const secondary = (secondaryColorInput && secondaryColorInput.value) || "#8B5CF6";

    if (previewTitle) {
        previewTitle.textContent = title;
    }

    // Atualiza textos das bolhas
    if (previewBotMessage) {
        // mensagem de boas-vindas configurada
        previewBotMessage.textContent = message;
    }
    if (previewUserMessage) {
        // mensagem de exemplo do usu√°rio (pode deixar fixa)
        previewUserMessage.textContent = "Ol√°! Como voc√™ pode me ajudar?";
    }

    if (previewAvatar) {
        previewAvatar.src = botAvatar;
    }

    const botBubbleColorInput = document.getElementById("bot-bubble-color");
    const botBubbleColor = (botBubbleColorInput && botBubbleColorInput.value) || primary;
    
    previewRoot.style.setProperty("--chat-preview-primary", primary);
    previewRoot.style.setProperty("--chat-preview-secondary", secondary);
    previewRoot.style.setProperty("--chat-preview-bot-bubble-color", botBubbleColor);
    
    // Aplicar papel de parede na pr√©-visualiza√ß√£o
    const bgEnabledInput = document.getElementById("chat-background-enabled");
    const bgTypeInput = document.getElementById("chat-background-type");
    const bgColorInput = document.getElementById("chat-background-color");
    const bgImageUrlInput = document.getElementById("chat-background-image-url");
    
    const previewBody = previewRoot.querySelector(".chat-preview-body");
    
    if (previewBody) {
        const enabled = bgEnabledInput ? bgEnabledInput.checked : true;
        const type = bgTypeInput ? bgTypeInput.value || "default" : "default";
        const color = bgColorInput ? bgColorInput.value || "" : "";
        const imageUrl = bgImageUrlInput ? bgImageUrlInput.value || "" : "";
        
        // Reset estilos anteriores
        previewBody.style.removeProperty("background-image");
        previewBody.style.removeProperty("background-color");
        previewBody.style.removeProperty("background-size");
        previewBody.style.removeProperty("background-position");
        previewBody.style.removeProperty("background-repeat");
        
        if (enabled && type !== "default") {
            if (type === "image" && imageUrl) {
                previewBody.style.backgroundImage = `url("${imageUrl}")`;
                previewBody.style.backgroundSize = "cover";
                previewBody.style.backgroundPosition = "center";
                previewBody.style.backgroundRepeat = "no-repeat";
            } else if (type === "color" && color) {
                previewBody.style.backgroundColor = color;
            }
            // Se n√£o tiver valor v√°lido, fica com o padr√£o do CSS
        }
    }
}

// Fun√ß√£o para atualizar o preview do launcher
function updateLauncherPreviewFromForm() {
    const bubbleEl = document.getElementById("launcher-preview-bubble");
    const avatarEl = document.getElementById("launcher-preview-avatar");
    const primaryInput = document.getElementById("primary-color");
    const secondaryInput = document.getElementById("secondary-color");
    const botAvatarInput = document.getElementById("bot-avatar");

    if (!bubbleEl || !avatarEl) {
        return;
    }

    const primary = (primaryInput && primaryInput.value) || "#3D7EFF";
    const secondary = (secondaryInput && secondaryInput.value) || "#8B5CF6";
    const avatarUrl = (botAvatarInput && botAvatarInput.value) || "/static/assets/logo.png";

    // Gradiente do bubble baseado nas cores escolhidas
    bubbleEl.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;

    // Avatar
    avatarEl.src = avatarUrl;
}

// ===== FUN√á√ïES PARA GERENCIAR BOT√ïES R√ÅPIDOS =====

// Valores padr√£o para bot√µes r√°pidos
const DEFAULT_QUICK_ACTIONS = [
    { label: 'üíª Como come√ßar?',      message: 'Quero saber como come√ßar na programa√ß√£o.' },
    { label: 'üéØ Dicas de carreira',  message: 'Quais s√£o as dicas de carreira em tecnologia?' },
    { label: 'üîß Ferramentas √∫teis',  message: 'Quais ferramentas s√£o √∫teis para programa√ß√£o?' },
    { label: 'üìö Recursos de estudo', message: 'Quais s√£o os melhores recursos de estudo?' }
];

// Renderiza o formul√°rio de bot√µes r√°pidos
function renderQuickActionsForm(actions) {
    const container = document.getElementById("quick-actions-list");
    if (!container) return;
    
    container.innerHTML = '';
    
    // Se actions for vazio, criar pelo menos 1 linha vazia para iniciar
    const actionsToRender = Array.isArray(actions) && actions.length > 0 ? actions : [{}];
    
    actionsToRender.forEach((action, index) => {
        addQuickActionRow(action, index);
    });
}

// Adiciona uma nova linha de bot√£o r√°pido
function addQuickActionRow(initialData = {}, index = null) {
    const container = document.getElementById("quick-actions-list");
    if (!container) return;
    
    // Limite de 4 bot√µes
    const existingRows = container.querySelectorAll('.quick-action-row');
    if (existingRows.length >= 4) {
        return;
    }
    
    // Se index n√£o foi fornecido, usar o pr√≥ximo √≠ndice dispon√≠vel
    if (index === null) {
        index = existingRows.length;
    }
    
    const row = document.createElement('div');
    row.className = 'quick-action-row mb-3';
    row.dataset.index = index;
    
    row.innerHTML = `
        <div class="row g-2">
            <div class="col-md-5">
                <label class="form-label small">Texto do bot√£o (label)</label>
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Ex: üíª Como come√ßar?" 
                       value="${(initialData.label || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="col-md-6">
                <label class="form-label small">Mensagem enviada (message)</label>
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Ex: Como come√ßar na programa√ß√£o?" 
                       value="${(initialData.message || '').replace(/"/g, '&quot;')}">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-quick-action-btn" title="Remover bot√£o">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(row);
    
    // Conectar bot√£o remover
    const removeBtn = row.querySelector('.remove-quick-action-btn');
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            row.remove();
            updateChatPreview(); // Atualizar preview ao remover
        });
    }
    
    // Atualizar preview quando os inputs mudarem
    const inputs = row.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', updateChatPreview);
    });
}

// Coleta os bot√µes r√°pidos do formul√°rio
function collectQuickActionsFromForm() {
    const container = document.getElementById("quick-actions-list");
    if (!container) return [];
    
    const rows = container.querySelectorAll('.quick-action-row');
    const actions = [];
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 2) {
            const label = inputs[0].value.trim();
            const message = inputs[1].value.trim();
            
            // Ignora linhas completamente vazias
            if (label || message) {
                actions.push({
                    label: label || message, // Fallback: se n√£o tiver label, usa message
                    message: message || label // Fallback: se n√£o tiver message, usa label
                });
            }
        }
    });
    
    return actions;
}

// Atualiza o preview dos bot√µes r√°pidos no chat-preview
function updateQuickActionsPreview() {
    const previewContainer = document.getElementById("chat-preview-quick-actions");
    if (!previewContainer) return;
    
    const enabled = document.getElementById("quick-actions-enabled")?.checked || false;
    const actions = collectQuickActionsFromForm();
    
    previewContainer.innerHTML = '';
    
    if (enabled && actions.length > 0) {
        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.className = 'preview-quick-btn';
            btn.textContent = action.label || action.message;
            btn.style.cssText = 'margin: 4px; padding: 6px 12px; border-radius: 20px; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: inherit; cursor: default;';
            btn.disabled = true;
            previewContainer.appendChild(btn);
        });
        previewContainer.style.display = 'flex';
        previewContainer.style.flexWrap = 'wrap';
    } else {
        previewContainer.style.display = 'none';
    }
}

// Atualizar updateChatPreview para incluir bot√µes r√°pidos
// Salvar refer√™ncia original
const originalUpdateChatPreview = updateChatPreview;
// Sobrescrever fun√ß√£o
window.updateChatPreview = function() {
    originalUpdateChatPreview();
    updateQuickActionsPreview();
};

document.addEventListener("DOMContentLoaded", function () {
    const THEME_STORAGE_KEY = "chatleo_admin_theme";
    const toggle = document.getElementById("admin-theme-toggle");
    const valueInput = document.getElementById("admin-theme-value");

    if (!toggle || !valueInput) {
        return;
    }

    function applyThemeToBody(theme) {
        const body = document.body;
        if (!body) return;

        body.classList.remove("theme-dark", "theme-light");
        body.classList.add("theme-" + theme);
    }

    function applyToggleVisual(theme) {
        // classe que move o "thumb" pro lado direito quando for dark
        if (theme === "dark") {
            toggle.classList.add("is-dark");
        } else {
            toggle.classList.remove("is-dark");
        }

        toggle.dataset.theme = theme;
        valueInput.value = theme;
    }

    async function loadSettings() {
        try {
            const res = await fetch("/admin/api/settings");
            if (!res.ok) throw new Error("Erro ao carregar configura√ß√µes");
            const data = await res.json();

            const globalCfg = data.global || {};
            let theme = globalCfg.admin_theme;
            
            // Se o backend retornou um tema, use e salve no localStorage
            if (theme) {
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            } else {
                // Se o backend n√£o retornou (Firestore desabilitado), tente ler do localStorage
                const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
                theme = savedTheme || "dark";
            }

            applyToggleVisual(theme);
            applyThemeToBody(theme);
            
            // Carregar configura√ß√µes do chat
            if (data.chat) {
                if (data.chat.chat_title) {
                    document.getElementById("chat-title").value = data.chat.chat_title;
                }
                if (data.chat.welcome_message) {
                    document.getElementById("welcome-message").value = data.chat.welcome_message;
                }
                if (data.chat.bot_avatar) {
                    document.getElementById("bot-avatar").value = data.chat.bot_avatar;
                }
                if (data.chat.user_avatar) {
                    document.getElementById("user-avatar").value = data.chat.user_avatar;
                }
                if (data.chat.primary_color) {
                    document.getElementById("primary-color").value = data.chat.primary_color;
                }
                if (data.chat.secondary_color) {
                    document.getElementById("secondary-color").value = data.chat.secondary_color;
                }
                
                // Carregar cor do bal√£o do bot
                const botBubbleColorInput = document.getElementById("bot-bubble-color");
                if (botBubbleColorInput) {
                    if (data.chat.bot_bubble_color) {
                        botBubbleColorInput.value = data.chat.bot_bubble_color;
                    } else {
                        // Fallback: usa cor prim√°ria se n√£o tiver cor espec√≠fica do bot
                        botBubbleColorInput.value = data.chat.primary_color || "#3D7EFF";
                    }
                }
                
                // Carregar configura√ß√µes de papel de parede
                const chatBgEnabled = data.chat.chat_background_enabled !== undefined 
                    ? data.chat.chat_background_enabled 
                    : true; // default: true
                const chatBgType = data.chat.chat_background_type || "default";
                const chatBgColor = data.chat.chat_background_color || "";
                const chatBgImageUrl = data.chat.chat_background_image_url || "";
                
                const bgEnabledCheckbox = document.getElementById("chat-background-enabled");
                const bgTypeSelect = document.getElementById("chat-background-type");
                const bgColorInput = document.getElementById("chat-background-color");
                const bgImageUrlInput = document.getElementById("chat-background-image-url");
                
                if (bgEnabledCheckbox) {
                    bgEnabledCheckbox.checked = chatBgEnabled;
                }
                if (bgTypeSelect) {
                    bgTypeSelect.value = chatBgType;
                    toggleBackgroundFields(chatBgType);
                }
                if (bgColorInput && chatBgColor) {
                    bgColorInput.value = chatBgColor;
                }
                if (bgImageUrlInput) {
                    bgImageUrlInput.value = chatBgImageUrl;
                }
                
                // Carregar configura√ß√µes de bot√µes r√°pidos
                const chat = data.chat || {};
                
                let quickActions = Array.isArray(chat.quick_actions) ? chat.quick_actions : [];
                const hasSavedQuickActions = quickActions.length > 0;
                
                // Se n√£o houver quick_actions salvos, usar os defaults
                if (!hasSavedQuickActions) {
                    quickActions = DEFAULT_QUICK_ACTIONS.slice();
                }
                
                const quickActionsEnabled = (typeof chat.quick_actions_enabled === 'boolean')
                    ? chat.quick_actions_enabled
                    : true; // default ligado quando estamos usando os defaults
                
                const quickActionsCheckbox = document.getElementById("quick-actions-enabled");
                if (quickActionsCheckbox) {
                    quickActionsCheckbox.checked = quickActionsEnabled;
                }
                
                renderQuickActionsForm(quickActions);
                
                // Atualizar pr√©-visualiza√ß√£o com os valores carregados
                updateChatPreview();
                updateLauncherPreviewFromForm();
            } else {
                // Se n√£o houver dados do chat, usar defaults
                const quickActionsCheckbox = document.getElementById("quick-actions-enabled");
                if (quickActionsCheckbox) {
                    quickActionsCheckbox.checked = true; // default ligado
                }
                renderQuickActionsForm(DEFAULT_QUICK_ACTIONS.slice());
                updateChatPreview();
                updateLauncherPreviewFromForm();
            }
        } catch (err) {
            console.error("Erro ao carregar configura√ß√µes:", err);
            // Fallback: tente ler do localStorage, sen√£o use "dark"
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const theme = savedTheme || "dark";
            applyToggleVisual(theme);
            applyThemeToBody(theme);
            // Atualizar pr√©-visualiza√ß√£o com valores padr√£o mesmo em caso de erro
            updateChatPreview();
            updateLauncherPreviewFromForm();
        }
    }

    async function saveTheme(theme) {
        // Sempre salva no localStorage, independente do resultado da API
        try {
            localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch (e) {
            console.warn("N√£o foi poss√≠vel salvar tema no localStorage:", e);
        }
        
        // Tenta salvar no Firestore tamb√©m (se estiver habilitado)
        try {
            const payload = {
                global: {
                    admin_theme: theme
                }
            };

            const res = await fetch("/admin/api/settings", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                throw new Error("Erro ao salvar o tema");
            }

            console.log("Tema salvo:", theme);
        } catch (err) {
            console.error("Erro ao salvar tema no servidor:", err);
            // N√£o importa se falhar, o localStorage j√° foi salvo acima
        }
    }

    toggle.addEventListener("click", async function () {
        const current = valueInput.value === "light" ? "light" : "dark";
        const next = current === "dark" ? "light" : "dark";

        applyToggleVisual(next);
        applyThemeToBody(next);
        await saveTheme(next);
    });

    // inicializa√ß√£o:
    loadSettings();
    
    // Adicionar listeners para atualizar pr√©-visualiza√ß√£o em tempo real
    const previewFields = [
        "chat-title",
        "welcome-message",
        "bot-avatar",
        "primary-color",
        "secondary-color",
        "chat-background-enabled",
        "chat-background-type",
        "chat-background-color",
        "chat-background-image-url",
        "bot-bubble-color",
    ];

    previewFields.forEach(function (id) {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener("input", updateChatPreview);
            el.addEventListener("change", updateChatPreview);
        }
    });
    
    // Adicionar listeners para atualizar preview do launcher em tempo real
    const botAvatarInput = document.getElementById("bot-avatar");
    const primaryInput = document.getElementById("primary-color");
    const secondaryInput = document.getElementById("secondary-color");

    if (botAvatarInput) {
        botAvatarInput.addEventListener("input", updateLauncherPreviewFromForm);
        botAvatarInput.addEventListener("blur", updateLauncherPreviewFromForm);
    }

    if (primaryInput) {
        primaryInput.addEventListener("input", updateLauncherPreviewFromForm);
        primaryInput.addEventListener("change", updateLauncherPreviewFromForm);
    }

    if (secondaryInput) {
        secondaryInput.addEventListener("input", updateLauncherPreviewFromForm);
        secondaryInput.addEventListener("change", updateLauncherPreviewFromForm);
    }
    
    // Event listener para checkbox de enable dos bot√µes r√°pidos
    const quickActionsEnabledCheckbox = document.getElementById("quick-actions-enabled");
    if (quickActionsEnabledCheckbox) {
        quickActionsEnabledCheckbox.addEventListener("change", updateChatPreview);
    }
    
    // Event listener para bot√£o "Adicionar bot√£o r√°pido"
    const addQuickActionBtn = document.getElementById("add-quick-action-btn");
    if (addQuickActionBtn) {
        addQuickActionBtn.addEventListener("click", function() {
            addQuickActionRow({});
        });
    }
    
    // Event listener para tipo de fundo do papel de parede
    const bgTypeSelect = document.getElementById("chat-background-type");
    if (bgTypeSelect) {
        bgTypeSelect.addEventListener("change", function() {
            toggleBackgroundFields(this.value);
        });
        // Inicializar visibilidade dos campos
        toggleBackgroundFields(bgTypeSelect.value);
    }
});

// Fun√ß√£o para mostrar feedback usando SweetAlert2 (padr√£o Velzon)
function showFeedback(message, isError = false, isWarning = false) {
    const icon = isError ? 'error' : (isWarning ? 'warning' : 'success');
    const title = isError
        ? 'Ops...'
        : isWarning
            ? 'Aten√ß√£o'
            : 'Tudo certo!';

    Swal.fire({
        title: title,
        text: message,
        icon: icon,
        confirmButtonText: 'Ok',
        buttonsStyling: false,
        customClass: {
            confirmButton: 'btn btn-primary w-xs'
        }
    });
}

// Salvar configura√ß√µes do chat
document.getElementById("save-chat-config").addEventListener("click", async function() {
    const quickActionsEnabled = document.getElementById("quick-actions-enabled").checked;
    const quickActions = collectQuickActionsFromForm();
    
    const botBubbleColorInput = document.getElementById("bot-bubble-color");
    
    const chatConfig = {
        chat_title: document.getElementById("chat-title").value,
        welcome_message: document.getElementById("welcome-message").value,
        bot_avatar: document.getElementById("bot-avatar").value,
        user_avatar: document.getElementById("user-avatar").value,
        primary_color: document.getElementById("primary-color").value,
        secondary_color: document.getElementById("secondary-color").value,
        bot_bubble_color: botBubbleColorInput && botBubbleColorInput.value
            ? botBubbleColorInput.value
            : document.getElementById("primary-color").value,
        quick_actions_enabled: quickActionsEnabled,
        quick_actions: quickActions,
        chat_background_enabled: document.getElementById("chat-background-enabled").checked,
        chat_background_type: document.getElementById("chat-background-type").value || "default",
        chat_background_color: document.getElementById("chat-background-color").value || "",
        chat_background_image_url: document.getElementById("chat-background-image-url").value || "",
    };
    
    try {
        const resp = await fetch("/admin/api/settings", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                chat: chatConfig
            }),
        });
        
        const data = await resp.json();
        if (data.ok && !data.firestore_disabled) {
            showFeedback("Configura√ß√µes do chat salvas com sucesso!");
        } else if (data.ok && data.firestore_disabled) {
            showFeedback(
                "Firestore est√° desabilitado neste ambiente. As configura√ß√µes n√£o foram salvas no banco.",
                false,
                true
            );
            return;
        } else {
            showFeedback(data.message || "Erro ao salvar configura√ß√µes.", true);
            return;
        }
    } catch (err) {
        showFeedback("Erro ao conectar ao servidor.", true);
    }
});

// Trocar senha
document.getElementById("change-password").addEventListener("click", async function() {
    const current = document.getElementById("current-password").value;
    const newPwd = document.getElementById("new-password").value;
    const confirm = document.getElementById("confirm-password").value;
    
    if (!current || !newPwd || !confirm) {
        showFeedback("Preencha todos os campos.", true);
        return;
    }
    
    if (newPwd !== confirm) {
        showFeedback("Confirma√ß√£o de senha n√£o confere.", true);
        return;
    }
    
    try {
        const resp = await fetch("/admin/api/change-password", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                current_password: current,
                new_password: newPwd,
                confirm_password: confirm
            }),
        });
        
        const data = await resp.json();
        if (data.ok) {
            showFeedback(data.message || "Senha alterada com sucesso!");
            // Limpar campos
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
        } else {
            showFeedback(data.message || "Erro ao alterar senha.", true);
        }
    } catch (err) {
        showFeedback("Erro ao conectar ao servidor.", true);
    }
});
</script>

<style>
.card {
    background-color: var(--app-bg-light);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-normal);
}

.form-control, .form-select {
    background-color: rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--text-normal);
}

.form-control:focus, .form-select:focus {
    background-color: rgba(0, 0, 0, 0.4);
    border-color: var(--accent);
    color: var(--text-normal);
}

.btn-primary {
    background: linear-gradient(135deg, #3d7eff, #4da3ff);
    border: none;
    color: white;
    font-weight: 500;
}

.btn-primary:hover {
    filter: brightness(1.1);
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
}

.alert-success {
    background-color: rgba(61, 225, 161, 0.2);
    border: 1px solid rgba(61, 225, 161, 0.4);
    color: #61e1a1;
}

.alert-danger {
    background-color: rgba(255, 129, 129, 0.2);
    border: 1px solid rgba(255, 129, 129, 0.4);
    color: #ff8181;
}
</style>

{% endblock %}

