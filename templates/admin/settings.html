{% extends 'admin/base.html' %}

{% block content %}

<div class="main-header-line">
    <h1>Configura√ß√µes</h1>
    <div class="action-buttons">
        <button class="menu-button">
            <i class="bi bi-list"></i>
        </button>
    </div>
</div>

<!-- Se√ß√£o 1: Tema do Painel -->
<div class="card-section mt-4">
    <div class="section-title-wrapper">
        <h5 class="section-title">
            <i class="bi bi-palette"></i>
            Tema do Painel
        </h5>
    </div>
    
    <div class="card p-4">
        <div class="mb-3">
            <label class="form-label d-block mb-2">Tema</label>
            
            <!-- valor real que ser√° salvo -->
            <input type="hidden"
                   id="admin-theme-value"
                   value="{{ admin_theme or 'dark' }}">
            
            <div class="theme-toggle-wrapper">
                <span class="theme-toggle-label">Claro</span>
                
                <button type="button"
                        id="admin-theme-toggle"
                        class="theme-toggle"
                        data-theme="{{ admin_theme or 'dark' }}"
                        aria-label="Alternar tema do painel">
                    <span class="theme-toggle-icon">üåû</span>
                    <span class="theme-toggle-thumb"></span>
                    <span class="theme-toggle-icon">üåô</span>
                </button>
                
                <span class="theme-toggle-label">Escuro</span>
            </div>
        </div>
        
        <small class="text-muted">
            O tema √© aplicado ao painel administrativo como modo claro ou escuro.
        </small>
    </div>
</div>

<!-- Se√ß√£o 2: Personaliza√ß√£o do Chat -->
<div class="card-section mt-4">
    <div class="section-title-wrapper">
        <h5 class="section-title">
            <i class="bi bi-chat-dots"></i>
            Personaliza√ß√£o do Chat
        </h5>
    </div>
    
    <div class="card p-4">
        <div class="mb-3">
            <label for="chat-title" class="form-label">T√≠tulo do Chat</label>
            <input type="text" id="chat-title" class="form-control" placeholder="ChatLeo">
        </div>
        
        <div class="mb-3">
            <label for="welcome-message" class="form-label">Mensagem de Boas-vindas</label>
            <textarea id="welcome-message" class="form-control" rows="3" placeholder="Ol√°! üëã Sou o assistente..."></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="bot-avatar" class="form-label">URL Avatar do Bot</label>
                <input type="text" id="bot-avatar" class="form-control" placeholder="/static/assets/logo.png">
            </div>
            <div class="col-md-6 mb-3">
                <label for="user-avatar" class="form-label">URL Avatar do Usu√°rio</label>
                <input type="text" id="user-avatar" class="form-control" placeholder="/static/assets/logo-user.png">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="primary-color" class="form-label">Cor Prim√°ria</label>
                <input type="color" id="primary-color" class="form-control form-control-color" value="#3D7EFF">
            </div>
            <div class="col-md-6 mb-3">
                <label for="secondary-color" class="form-label">Cor Secund√°ria</label>
                <input type="color" id="secondary-color" class="form-control form-control-color" value="#8B5CF6">
            </div>
        </div>
        
    </div>
    
    <!-- Previews lado a lado -->
    <div class="row mt-4">
        <div class="col-md-6 mb-3 mb-md-0">
            <div class="card-section">
                <div class="section-title-wrapper">
                    <h5 class="section-title">
                        <i class="bi bi-circle"></i>
                        Preview do Launcher
                    </h5>
                </div>
                <div class="launcher-preview-wrapper">
                    <div class="launcher-preview-surface">
                        <!-- canto inferior direito simulando a p√°gina -->
                        <div class="launcher-preview-bubble" id="launcher-preview-bubble">
                            <div class="launcher-preview-avatar">
                                <img id="launcher-preview-avatar" src="/static/assets/logo.png" alt="Avatar do bot">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card-section">
                <div class="section-title-wrapper">
                    <h5 class="section-title">
                        <i class="bi bi-eye"></i>
                        Pr√©-visualiza√ß√£o do Chat
                    </h5>
                </div>

                <div id="chat-preview" class="chat-preview">
                    <div class="chat-preview-header">
                        <div class="chat-preview-avatar">
                            <img id="chat-preview-bot-avatar" src="/static/assets/logo.png" alt="Avatar do bot">
                        </div>
                        <div class="chat-preview-title-group">
                            <div id="chat-preview-title" class="chat-preview-title">ChatLeo</div>
                            <small class="chat-preview-subtitle">Janela de exemplo do usu√°rio</small>
                        </div>
                    </div>

                    <div class="chat-preview-body">
                        <div class="chat-preview-bubble">
                            <span id="chat-preview-message">
                                Ol√°! üëã Sou o assistente...
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="save-chat-config" class="btn btn-primary mt-4">Salvar Configura√ß√µes do Chat</button>
</div>

<!-- Se√ß√£o 3: Troca de Senha -->
<div class="card-section mt-4">
    <div class="section-title-wrapper">
        <h5 class="section-title">
            <i class="bi bi-shield-lock"></i>
            Seguran√ßa
        </h5>
    </div>
    
    <div class="card p-4">
        <div class="mb-3">
            <label for="current-password" class="form-label">Senha Atual</label>
            <input type="password" id="current-password" class="form-control" placeholder="Digite sua senha atual">
        </div>
        
        <div class="mb-3">
            <label for="new-password" class="form-label">Nova Senha</label>
            <input type="password" id="new-password" class="form-control" placeholder="Digite a nova senha">
        </div>
        
        <div class="mb-3">
            <label for="confirm-password" class="form-label">Confirmar Nova Senha</label>
            <input type="password" id="confirm-password" class="form-control" placeholder="Confirme a nova senha">
        </div>
        
        <button id="change-password" class="btn btn-primary">Alterar Senha</button>
    </div>
</div>

<!-- Mensagens de feedback -->
<div id="settings-feedback" class="mt-3" style="display: none;"></div>

<script>
// Fun√ß√£o para atualizar a pr√©-visualiza√ß√£o do chat
function updateChatPreview() {
    const titleInput = document.getElementById("chat-title");
    const messageInput = document.getElementById("welcome-message");
    const botAvatarInput = document.getElementById("bot-avatar");
    const primaryColorInput = document.getElementById("primary-color");
    const secondaryColorInput = document.getElementById("secondary-color");

    const previewRoot = document.getElementById("chat-preview");
    const previewTitle = document.getElementById("chat-preview-title");
    const previewMessage = document.getElementById("chat-preview-message");
    const previewAvatar = document.getElementById("chat-preview-bot-avatar");

    if (!previewRoot) return;

    const title = (titleInput && titleInput.value) || "ChatLeo";
    const message = (messageInput && messageInput.value) || "Ol√°! üëã Sou o assistente...";
    const botAvatar = (botAvatarInput && botAvatarInput.value) || "/static/assets/logo.png";
    const primary = (primaryColorInput && primaryColorInput.value) || "#3D7EFF";
    const secondary = (secondaryColorInput && secondaryColorInput.value) || "#8B5CF6";

    if (previewTitle) {
        previewTitle.textContent = title;
    }

    if (previewMessage) {
        previewMessage.textContent = message;
    }

    if (previewAvatar) {
        previewAvatar.src = botAvatar;
    }

    previewRoot.style.setProperty("--chat-preview-primary", primary);
    previewRoot.style.setProperty("--chat-preview-secondary", secondary);
}

// Fun√ß√£o para atualizar o preview do launcher
function updateLauncherPreviewFromForm() {
    const bubbleEl = document.getElementById("launcher-preview-bubble");
    const avatarEl = document.getElementById("launcher-preview-avatar");
    const primaryInput = document.getElementById("primary-color");
    const secondaryInput = document.getElementById("secondary-color");
    const botAvatarInput = document.getElementById("bot-avatar");

    if (!bubbleEl || !avatarEl) {
        return;
    }

    const primary = (primaryInput && primaryInput.value) || "#3D7EFF";
    const secondary = (secondaryInput && secondaryInput.value) || "#8B5CF6";
    const avatarUrl = (botAvatarInput && botAvatarInput.value) || "/static/assets/logo.png";

    // Gradiente do bubble baseado nas cores escolhidas
    bubbleEl.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;

    // Avatar
    avatarEl.src = avatarUrl;
}

document.addEventListener("DOMContentLoaded", function () {
    const THEME_STORAGE_KEY = "chatleo_admin_theme";
    const toggle = document.getElementById("admin-theme-toggle");
    const valueInput = document.getElementById("admin-theme-value");

    if (!toggle || !valueInput) {
        return;
    }

    function applyThemeToBody(theme) {
        const body = document.body;
        if (!body) return;

        body.classList.remove("theme-dark", "theme-light");
        body.classList.add("theme-" + theme);
    }

    function applyToggleVisual(theme) {
        // classe que move o "thumb" pro lado direito quando for dark
        if (theme === "dark") {
            toggle.classList.add("is-dark");
        } else {
            toggle.classList.remove("is-dark");
        }

        toggle.dataset.theme = theme;
        valueInput.value = theme;
    }

    async function loadSettings() {
        try {
            const res = await fetch("/admin/api/settings");
            if (!res.ok) throw new Error("Erro ao carregar configura√ß√µes");
            const data = await res.json();

            const globalCfg = data.global || {};
            let theme = globalCfg.admin_theme;
            
            // Se o backend retornou um tema, use e salve no localStorage
            if (theme) {
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            } else {
                // Se o backend n√£o retornou (Firestore desabilitado), tente ler do localStorage
                const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
                theme = savedTheme || "dark";
            }

            applyToggleVisual(theme);
            applyThemeToBody(theme);
            
            // Carregar configura√ß√µes do chat
            if (data.chat) {
                if (data.chat.chat_title) {
                    document.getElementById("chat-title").value = data.chat.chat_title;
                }
                if (data.chat.welcome_message) {
                    document.getElementById("welcome-message").value = data.chat.welcome_message;
                }
                if (data.chat.bot_avatar) {
                    document.getElementById("bot-avatar").value = data.chat.bot_avatar;
                }
                if (data.chat.user_avatar) {
                    document.getElementById("user-avatar").value = data.chat.user_avatar;
                }
                if (data.chat.primary_color) {
                    document.getElementById("primary-color").value = data.chat.primary_color;
                }
                if (data.chat.secondary_color) {
                    document.getElementById("secondary-color").value = data.chat.secondary_color;
                }
                
                // Atualizar pr√©-visualiza√ß√£o com os valores carregados
                updateChatPreview();
                updateLauncherPreviewFromForm();
            } else {
                // Atualizar pr√©-visualiza√ß√£o mesmo se n√£o houver dados carregados
                updateChatPreview();
                updateLauncherPreviewFromForm();
            }
        } catch (err) {
            console.error("Erro ao carregar configura√ß√µes:", err);
            // Fallback: tente ler do localStorage, sen√£o use "dark"
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const theme = savedTheme || "dark";
            applyToggleVisual(theme);
            applyThemeToBody(theme);
            // Atualizar pr√©-visualiza√ß√£o com valores padr√£o mesmo em caso de erro
            updateChatPreview();
            updateLauncherPreviewFromForm();
        }
    }

    async function saveTheme(theme) {
        // Sempre salva no localStorage, independente do resultado da API
        try {
            localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch (e) {
            console.warn("N√£o foi poss√≠vel salvar tema no localStorage:", e);
        }
        
        // Tenta salvar no Firestore tamb√©m (se estiver habilitado)
        try {
            const payload = {
                global: {
                    admin_theme: theme
                }
            };

            const res = await fetch("/admin/api/settings", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                throw new Error("Erro ao salvar o tema");
            }

            console.log("Tema salvo:", theme);
        } catch (err) {
            console.error("Erro ao salvar tema no servidor:", err);
            // N√£o importa se falhar, o localStorage j√° foi salvo acima
        }
    }

    toggle.addEventListener("click", async function () {
        const current = valueInput.value === "light" ? "light" : "dark";
        const next = current === "dark" ? "light" : "dark";

        applyToggleVisual(next);
        applyThemeToBody(next);
        await saveTheme(next);
    });

    // inicializa√ß√£o:
    loadSettings();
    
    // Adicionar listeners para atualizar pr√©-visualiza√ß√£o em tempo real
    const previewFields = [
        "chat-title",
        "welcome-message",
        "bot-avatar",
        "primary-color",
        "secondary-color",
    ];

    previewFields.forEach(function (id) {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener("input", updateChatPreview);
            el.addEventListener("change", updateChatPreview);
        }
    });
    
    // Adicionar listeners para atualizar preview do launcher em tempo real
    const botAvatarInput = document.getElementById("bot-avatar");
    const primaryInput = document.getElementById("primary-color");
    const secondaryInput = document.getElementById("secondary-color");

    if (botAvatarInput) {
        botAvatarInput.addEventListener("input", updateLauncherPreviewFromForm);
        botAvatarInput.addEventListener("blur", updateLauncherPreviewFromForm);
    }

    if (primaryInput) {
        primaryInput.addEventListener("input", updateLauncherPreviewFromForm);
        primaryInput.addEventListener("change", updateLauncherPreviewFromForm);
    }

    if (secondaryInput) {
        secondaryInput.addEventListener("input", updateLauncherPreviewFromForm);
        secondaryInput.addEventListener("change", updateLauncherPreviewFromForm);
    }
});

// Fun√ß√£o para mostrar feedback usando SweetAlert2 (padr√£o Velzon)
function showFeedback(message, isError = false, isWarning = false) {
    const icon = isError ? 'error' : (isWarning ? 'warning' : 'success');
    const title = isError
        ? 'Ops...'
        : isWarning
            ? 'Aten√ß√£o'
            : 'Tudo certo!';

    Swal.fire({
        title: title,
        text: message,
        icon: icon,
        confirmButtonText: 'Ok',
        buttonsStyling: false,
        customClass: {
            confirmButton: 'btn btn-primary w-xs'
        }
    });
}

// Salvar configura√ß√µes do chat
document.getElementById("save-chat-config").addEventListener("click", async function() {
    const chatConfig = {
        chat_title: document.getElementById("chat-title").value,
        welcome_message: document.getElementById("welcome-message").value,
        bot_avatar: document.getElementById("bot-avatar").value,
        user_avatar: document.getElementById("user-avatar").value,
        primary_color: document.getElementById("primary-color").value,
        secondary_color: document.getElementById("secondary-color").value,
    };
    
    try {
        const resp = await fetch("/admin/api/settings", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                chat: chatConfig
            }),
        });
        
        const data = await resp.json();
        if (data.ok && !data.firestore_disabled) {
            showFeedback("Configura√ß√µes do chat salvas com sucesso!");
        } else if (data.ok && data.firestore_disabled) {
            showFeedback(
                "Firestore est√° desabilitado neste ambiente. As configura√ß√µes n√£o foram salvas no banco.",
                false,
                true
            );
            return;
        } else {
            showFeedback(data.message || "Erro ao salvar configura√ß√µes.", true);
            return;
        }
    } catch (err) {
        showFeedback("Erro ao conectar ao servidor.", true);
    }
});

// Trocar senha
document.getElementById("change-password").addEventListener("click", async function() {
    const current = document.getElementById("current-password").value;
    const newPwd = document.getElementById("new-password").value;
    const confirm = document.getElementById("confirm-password").value;
    
    if (!current || !newPwd || !confirm) {
        showFeedback("Preencha todos os campos.", true);
        return;
    }
    
    if (newPwd !== confirm) {
        showFeedback("Confirma√ß√£o de senha n√£o confere.", true);
        return;
    }
    
    try {
        const resp = await fetch("/admin/api/change-password", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                current_password: current,
                new_password: newPwd,
                confirm_password: confirm
            }),
        });
        
        const data = await resp.json();
        if (data.ok) {
            showFeedback(data.message || "Senha alterada com sucesso!");
            // Limpar campos
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
        } else {
            showFeedback(data.message || "Erro ao alterar senha.", true);
        }
    } catch (err) {
        showFeedback("Erro ao conectar ao servidor.", true);
    }
});
</script>

<style>
.card {
    background-color: var(--app-bg-light);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-normal);
}

.form-control, .form-select {
    background-color: rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--text-normal);
}

.form-control:focus, .form-select:focus {
    background-color: rgba(0, 0, 0, 0.4);
    border-color: var(--accent);
    color: var(--text-normal);
}

.btn-primary {
    background: linear-gradient(135deg, #3d7eff, #4da3ff);
    border: none;
    color: white;
    font-weight: 500;
}

.btn-primary:hover {
    filter: brightness(1.1);
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
}

.alert-success {
    background-color: rgba(61, 225, 161, 0.2);
    border: 1px solid rgba(61, 225, 161, 0.4);
    color: #61e1a1;
}

.alert-danger {
    background-color: rgba(255, 129, 129, 0.2);
    border: 1px solid rgba(255, 129, 129, 0.4);
    color: #ff8181;
}
</style>

{% endblock %}

